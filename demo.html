<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meetio Test Environment</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; min-height: 100vh; }

    /* Scenario Control Panel */
    .control-panel {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background: #1f2937; color: white; padding: 12px 20px;
      display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    }
    .control-panel h1 { font-size: 14px; font-weight: 600; }
    .control-panel button {
      background: #3b82f6; color: white; border: none; padding: 8px 16px;
      border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
    }
    .control-panel button:hover { background: #2563eb; }
    .control-panel button:disabled { background: #6b7280; cursor: not-allowed; }
    .control-panel button.danger { background: #ef4444; }
    .control-panel .settings { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    .control-panel input[type="number"] { width: 60px; padding: 6px; border-radius: 4px; border: none; }
    .control-panel label { font-size: 12px; color: #9ca3af; }
    .status { font-size: 12px; color: #10b981; }
    .status.running { color: #fbbf24; }

    /* App Container */
    .app { max-width: 900px; margin: 80px auto 40px; padding: 20px; }

    /* Product Card */
    .product-card {
      background: white; border-radius: 12px; padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 24px;
    }
    .product-image {
      width: 200px; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      color: white; font-size: 48px;
    }
    .product-info { flex: 1; }
    .product-info h2 { font-size: 24px; margin-bottom: 8px; }
    .product-info .price { font-size: 28px; font-weight: 700; color: #059669; margin: 16px 0; }
    .product-info .rating { color: #f59e0b; margin-bottom: 16px; }
    .product-info p { color: #6b7280; line-height: 1.6; margin-bottom: 20px; }

    /* Buttons */
    .btn {
      padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; border: none; transition: all 0.2s;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    /* Cart */
    .cart {
      background: white; border-radius: 12px; padding: 24px; margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cart h3 { margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .cart-badge { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    .cart-empty { color: #9ca3af; font-style: italic; }
    .cart-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
    .cart-total { display: flex; justify-content: space-between; padding: 16px 0; font-weight: 700; font-size: 18px; }

    /* Checkout Form */
    .checkout-form { display: none; margin-top: 20px; }
    .checkout-form.visible { display: block; }
    .checkout-form input {
      width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;
      margin-bottom: 12px; font-size: 14px;
    }
    .checkout-form input:focus { outline: none; border-color: #3b82f6; }

    /* States */
    .loading { opacity: 0.6; pointer-events: none; }
    .error { border-color: #ef4444 !important; }
    .error-msg { color: #ef4444; font-size: 13px; margin-bottom: 12px; display: none; }
    .error-msg.visible { display: block; }
    .success-msg { background: #d1fae5; color: #065f46; padding: 16px; border-radius: 8px; display: none; }
    .success-msg.visible { display: block; }

    /* Highlight effect for simulation */
    .about-to-click {
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4) !important;
      transition: box-shadow 0.2s;
    }

    /* Log panel (for debugging - can hide) */
    .log-panel {
      position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
      background: #111827; color: #10b981; font-family: monospace; font-size: 12px;
      padding: 12px; overflow-y: auto;
    }
    .log-panel .log-entry { margin-bottom: 4px; }
    .log-panel .log-warn { color: #fbbf24; }
    .log-panel .log-error { color: #ef4444; }
  </style>
</head>
<body>

<!-- Control Panel -->
<div class="control-panel">
  <h1>Meetio Test Environment</h1>

  <button id="btn-happy" onclick="runScenario('happy')">Happy Path</button>
  <button id="btn-error" onclick="runScenario('error')">Payment Error</button>
  <button id="btn-network" onclick="runScenario('network')">Network Fail</button>
  <button id="btn-stop" class="danger" onclick="stopScenario()" disabled>Stop</button>

  <div class="settings">
    <label>Max delay:</label>
    <input type="number" id="max-delay" value="2000" min="500" max="5000" step="100">
    <label>ms</label>
  </div>

  <span id="status" class="status">Ready</span>
</div>

<!-- Fake E-commerce App -->
<div class="app">
  <div class="product-card">
    <div class="product-image">W</div>
    <div class="product-info">
      <h2>Widget Pro</h2>
      <div class="rating">★★★★☆ (127 reviews)</div>
      <p>The ultimate widget for all your productivity needs. Features seamless integration, real-time sync, and an intuitive interface.</p>
      <div class="price">$49.99</div>
      <button id="add-to-cart" class="btn btn-primary">Add to Cart</button>
    </div>
  </div>

  <div class="cart">
    <h3>Shopping Cart <span id="cart-badge" class="cart-badge" style="display:none">0</span></h3>
    <div id="cart-items">
      <p class="cart-empty">Your cart is empty</p>
    </div>
    <div id="cart-total" class="cart-total" style="display:none">
      <span>Total</span>
      <span id="total-amount">$0.00</span>
    </div>
    <button id="checkout-btn" class="btn btn-success" style="display:none; margin-top: 12px;">
      Proceed to Checkout
    </button>
  </div>

  <div id="checkout-form" class="checkout-form">
    <h3 style="margin-bottom: 16px;">Payment Details</h3>
    <p id="payment-error" class="error-msg"></p>
    <input type="text" id="card-name" placeholder="Name on card">
    <input type="text" id="card-number" placeholder="Card number">
    <div style="display: flex; gap: 12px;">
      <input type="text" id="card-expiry" placeholder="MM/YY" style="flex:1">
      <input type="text" id="card-cvv" placeholder="CVV" style="flex:1">
    </div>
    <button id="pay-btn" class="btn btn-success" style="width: 100%;">Pay $49.99</button>
  </div>

  <div id="success-msg" class="success-msg">
    <strong>Order Confirmed!</strong><br>
    Thank you for your purchase. Order #12345 has been placed.
  </div>
</div>

<!-- Log Panel (shows what's happening) -->
<div class="log-panel" id="log-panel"></div>

<script>
  // ============ CONFIG ============
  const API_BASE = 'http://localhost:8000';  // FastAPI backend

  // ============ STATE ============
  let cart = [];
  let running = false;
  let abortController = null;

  // ============ LOGGING ============
  function log(msg, level = 'log') {
    // Console log (captured by rrweb)
    if (level === 'warn') console.warn(msg);
    else if (level === 'error') console.error(msg);
    else console.log(msg);

    // Visual log panel
    const panel = document.getElementById('log-panel');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${level}`;
    entry.textContent = `[${new Date().toISOString().substr(11, 12)}] ${msg}`;
    panel.appendChild(entry);
    panel.scrollTop = panel.scrollHeight;
  }

  // ============ UI EVENT HANDLERS ============
  document.getElementById('add-to-cart').onclick = async function() {
    log('EVENT: Add to Cart clicked');
    this.classList.add('loading');
    this.textContent = 'Adding...';

    try {
      const res = await fetch(`${API_BASE}/api/cart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product: 'widget-pro', price: 49.99 })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      log('SUCCESS: Item added to cart');
      cart.push({ name: 'Widget Pro', price: 49.99 });
      updateCartUI();
    } catch (e) {
      log(`ERROR: Failed to add to cart - ${e.message}`, 'error');
    }

    this.classList.remove('loading');
    this.textContent = 'Add to Cart';
  };

  document.getElementById('checkout-btn').onclick = function() {
    log('EVENT: Checkout button clicked');
    document.getElementById('checkout-form').classList.add('visible');
    log('INFO: Payment form displayed');
  };

  document.getElementById('pay-btn').onclick = async function() {
    log('EVENT: Pay button clicked');
    const errorEl = document.getElementById('payment-error');
    errorEl.classList.remove('visible');

    this.classList.add('loading');
    this.textContent = 'Processing...';
    log('INFO: Processing payment...');

    try {
      const res = await fetch(`${API_BASE}/api/payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: 49.99,
          card: document.getElementById('card-number').value
        })
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || `Payment failed: ${res.status}`);
      }

      log('SUCCESS: Payment completed!');
      document.getElementById('checkout-form').classList.remove('visible');
      document.getElementById('success-msg').classList.add('visible');
      cart = [];
      updateCartUI();

    } catch (e) {
      log(`ERROR: ${e.message}`, 'error');
      errorEl.textContent = e.message;
      errorEl.classList.add('visible');
      document.getElementById('card-number').classList.add('error');
    }

    this.classList.remove('loading');
    this.textContent = 'Pay $49.99';
  };

  function updateCartUI() {
    const itemsEl = document.getElementById('cart-items');
    const badgeEl = document.getElementById('cart-badge');
    const totalEl = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('checkout-btn');

    if (cart.length === 0) {
      itemsEl.innerHTML = '<p class="cart-empty">Your cart is empty</p>';
      badgeEl.style.display = 'none';
      totalEl.style.display = 'none';
      checkoutBtn.style.display = 'none';
    } else {
      itemsEl.innerHTML = cart.map(item =>
        `<div class="cart-item"><span>${item.name}</span><span>$${item.price.toFixed(2)}</span></div>`
      ).join('');
      badgeEl.textContent = cart.length;
      badgeEl.style.display = 'inline';
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
      totalEl.style.display = 'flex';
      checkoutBtn.style.display = 'block';
    }
  }

  // ============ SCENARIO RUNNER ============
  function random(min, max) {
    return min + Math.random() * (max - min);
  }

  function sleep(ms) {
    return new Promise(resolve => {
      const timeout = setTimeout(resolve, ms);
      if (abortController) {
        abortController.signal.addEventListener('abort', () => {
          clearTimeout(timeout);
          resolve();
        });
      }
    });
  }

  async function simulateClick(selector) {
    const el = document.querySelector(selector);
    if (!el) return;

    // Highlight
    el.classList.add('about-to-click');
    await sleep(300);
    el.classList.remove('about-to-click');

    // Click
    el.click();
  }

  async function simulateType(selector, text) {
    const el = document.querySelector(selector);
    if (!el) return;

    el.classList.add('about-to-click');
    await sleep(200);
    el.classList.remove('about-to-click');

    for (const char of text) {
      el.value += char;
      await sleep(50);
    }
  }

  const scenarios = {
    happy: [
      { action: () => log('STEP: Starting checkout flow') },
      { action: () => simulateClick('#add-to-cart') },
      { action: () => simulateClick('#checkout-btn') },
      { action: () => simulateType('#card-name', 'John Doe') },
      { action: () => simulateType('#card-number', '4242424242424242') },
      { action: () => simulateType('#card-expiry', '12/25') },
      { action: () => simulateType('#card-cvv', '123') },
      { action: () => simulateClick('#pay-btn') },
      { action: () => log('STEP: Checkout flow completed') },
    ],
    error: [
      { action: () => log('STEP: Starting error scenario') },
      { action: () => simulateClick('#add-to-cart') },
      { action: () => simulateClick('#checkout-btn') },
      { action: () => simulateType('#card-name', 'John Doe') },
      { action: () => simulateType('#card-number', '4000000000000002') }, // Decline card
      { action: () => simulateType('#card-expiry', '12/25') },
      { action: () => simulateType('#card-cvv', '123') },
      { action: () => simulateClick('#pay-btn') },
      { action: () => log('WARN: User may retry payment', 'warn') },
    ],
    network: [
      { action: () => log('STEP: Starting network failure scenario') },
      { action: async () => {
        log('INFO: Attempting request to failing endpoint');
        try {
          await fetch(`${API_BASE}/api/fail/network`);
        } catch (e) {
          log(`ERROR: Network request failed - ${e.message}`, 'error');
        }
      }},
      { action: () => log('WARN: Retrying operation...', 'warn') },
      { action: async () => {
        log('INFO: Fetching with slow endpoint');
        await fetch(`${API_BASE}/api/slow?delay=2`);
        log('SUCCESS: Slow request completed');
      }},
    ],
  };

  async function runScenario(name) {
    if (running) return;

    // Reset UI
    cart = [];
    updateCartUI();
    document.getElementById('checkout-form').classList.remove('visible');
    document.getElementById('success-msg').classList.remove('visible');
    document.getElementById('payment-error').classList.remove('visible');
    document.querySelectorAll('input').forEach(el => { el.value = ''; el.classList.remove('error'); });
    document.getElementById('log-panel').innerHTML = '';

    running = true;
    abortController = new AbortController();

    document.getElementById('status').textContent = `Running: ${name}`;
    document.getElementById('status').classList.add('running');
    document.getElementById('btn-stop').disabled = false;
    document.querySelectorAll('.control-panel button:not(.danger)').forEach(b => b.disabled = true);

    const maxDelay = parseInt(document.getElementById('max-delay').value) || 2000;
    const steps = scenarios[name];

    log(`=== SCENARIO: ${name.toUpperCase()} ===`);

    for (const step of steps) {
      if (!running) break;

      const delay = random(500, maxDelay);
      await sleep(delay);

      if (!running) break;
      await step.action();
    }

    stopScenario();
  }

  function stopScenario() {
    running = false;
    if (abortController) abortController.abort();

    document.getElementById('status').textContent = 'Ready';
    document.getElementById('status').classList.remove('running');
    document.getElementById('btn-stop').disabled = true;
    document.querySelectorAll('.control-panel button:not(.danger)').forEach(b => b.disabled = false);

    log('=== SCENARIO ENDED ===');
  }

  // Initial log
  log('STEP: Page loaded');
  log('INFO: Test environment ready');
</script>

</body>
</html>
